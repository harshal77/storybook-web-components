/*! For license information please see oms.js.LICENSE.txt */
(function(){var callbackName,callbackRegEx,scriptTag,tag,_ref,_ref1,__hasProp={}.hasOwnProperty,__slice=[].slice;this.OverlappingMarkerSpiderfier=function(){var ge,gm,mt,p,twoPi,_i,_len,_ref;for(_i=0,_len=(_ref=[_Class,p=_Class.prototype]).length;_i<_len;_i++)_ref[_i].VERSION="1.0.3";function _Class(_at_map,opts){var k,lcH,lcU,v,_this;for(k in this.map=_at_map,null==opts&&(opts={}),null==this.constructor.hasInitialized&&(this.constructor.hasInitialized=!0,gm=google.maps,ge=gm.event,mt=gm.MapTypeId,p.keepSpiderfied=!1,p.ignoreMapClick=!1,p.markersWontHide=!1,p.markersWontMove=!1,p.basicFormatEvents=!1,p.minZoomLevel=0,p.nearbyDistance=20,p.circleSpiralSwitchover=9,p.circleFootSeparation=23,p.circleStartAngle=twoPi/12,p.spiralFootSeparation=26,p.spiralLengthStart=11,p.spiralLengthFactor=4,p.spiderfiedZIndex=gm.Marker.MAX_ZINDEX+2e4,p.highlightedLegZIndex=gm.Marker.MAX_ZINDEX+1e4,p.usualLegZIndex=gm.Marker.MAX_ZINDEX+1,p.legWeight=1.5,p.legColors={usual:{},highlighted:{}},lcU=p.legColors.usual,lcH=p.legColors.highlighted,lcU[mt.HYBRID]=lcU[mt.SATELLITE]=opts.legColorNormalSatellite?opts.legColorNormalSatellite:"#fff",lcH[mt.HYBRID]=lcH[mt.SATELLITE]=opts.legColorHoveredSatellite?opts.legColorHoveredSatellite:"#f00",lcU[mt.TERRAIN]=lcU[mt.ROADMAP]=opts.legColorNormal?opts.legColorNormal:"#444",lcH[mt.TERRAIN]=lcH[mt.ROADMAP]=opts.legColorHovered?opts.legColorHovered:"#f00",this.constructor.ProjHelper=function(map){return this.setMap(map)},this.constructor.ProjHelper.prototype=new gm.OverlayView,this.constructor.ProjHelper.prototype.draw=function(){}),opts)__hasProp.call(opts,k)&&(v=opts[k],this[k]=v);this.projHelper=new this.constructor.ProjHelper(this.map),this.initMarkerArrays(),this.listeners={},this.formatIdleListener=this.formatTimeoutId=null,this.addListener("click",(function(marker,e){return ge.trigger(marker,"spider_click",e)})),this.addListener("format",(function(marker,status){return ge.trigger(marker,"spider_format",status)})),this.ignoreMapClick||ge.addListener(this.map,"click",(_this=this,function(){return _this.unspiderfy()})),ge.addListener(this.map,"maptypeid_changed",function(_this){return function(){return _this.unspiderfy()}}(this)),ge.addListener(this.map,"zoom_changed",function(_this){return function(){if(_this.unspiderfy(),!_this.basicFormatEvents)return _this.formatMarkers()}}(this))}return twoPi=2*Math.PI,gm=ge=mt=null,_Class.markerStatus={SPIDERFIED:"SPIDERFIED",SPIDERFIABLE:"SPIDERFIABLE",UNSPIDERFIABLE:"UNSPIDERFIABLE",UNSPIDERFIED:"UNSPIDERFIED"},p.initMarkerArrays=function(){return this.markers=[],this.markerListenerRefs=[]},p.addMarker=function(marker,spiderClickHandler){return marker.setMap(this.map),this.trackMarker(marker,spiderClickHandler)},p.trackMarker=function(marker,spiderClickHandler){var listenerRefs,_this;return null!=marker._oms||(marker._oms=!0,listenerRefs=[ge.addListener(marker,"click",(_this=this,function(e){return _this.spiderListener(marker,e)}))],this.markersWontHide||listenerRefs.push(ge.addListener(marker,"visible_changed",function(_this){return function(){return _this.markerChangeListener(marker,!1)}}(this))),this.markersWontMove||listenerRefs.push(ge.addListener(marker,"position_changed",function(_this){return function(){return _this.markerChangeListener(marker,!0)}}(this))),null!=spiderClickHandler&&listenerRefs.push(ge.addListener(marker,"spider_click",spiderClickHandler)),this.markerListenerRefs.push(listenerRefs),this.markers.push(marker),this.basicFormatEvents?this.trigger("format",marker,this.constructor.markerStatus.UNSPIDERFIED):(this.trigger("format",marker,this.constructor.markerStatus.UNSPIDERFIABLE),this.formatMarkers())),this},p.markerChangeListener=function(marker,positionChanged){if(!this.spiderfying&&!this.unspiderfying)return null==marker._omsData||!positionChanged&&marker.getVisible()||this.unspiderfy(positionChanged?marker:null),this.formatMarkers()},p.getMarkers=function(){return this.markers.slice(0)},p.removeMarker=function(marker){return this.forgetMarker(marker),marker.setMap(null)},p.forgetMarker=function(marker){var i,listenerRef,listenerRefs,_j,_len1;if(null!=marker._omsData&&this.unspiderfy(),(i=this.arrIndexOf(this.markers,marker))<0)return this;for(_j=0,_len1=(listenerRefs=this.markerListenerRefs.splice(i,1)[0]).length;_j<_len1;_j++)listenerRef=listenerRefs[_j],ge.removeListener(listenerRef);return delete marker._oms,this.markers.splice(i,1),this.formatMarkers(),this},p.removeAllMarkers=p.clearMarkers=function(){var markers,_j,_len1;for(markers=this.getMarkers(),this.forgetAllMarkers(),_j=0,_len1=markers.length;_j<_len1;_j++)markers[_j].setMap(null);return this},p.forgetAllMarkers=function(){var i,listenerRef,listenerRefs,marker,_j,_k,_len1,_len2,_ref1;for(this.unspiderfy(),i=_j=0,_len1=(_ref1=this.markers).length;_j<_len1;i=++_j){for(marker=_ref1[i],_k=0,_len2=(listenerRefs=this.markerListenerRefs[i]).length;_k<_len2;_k++)listenerRef=listenerRefs[_k],ge.removeListener(listenerRef);delete marker._oms}return this.initMarkerArrays(),this},p.addListener=function(eventName,func){var _base;return(null!=(_base=this.listeners)[eventName]?_base[eventName]:_base[eventName]=[]).push(func),this},p.removeListener=function(eventName,func){var i;return(i=this.arrIndexOf(this.listeners[eventName],func))<0||this.listeners[eventName].splice(i,1),this},p.clearListeners=function(eventName){return this.listeners[eventName]=[],this},p.trigger=function(){var args,eventName,func,_j,_len1,_ref1,_ref2,_results;for(eventName=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],_results=[],_j=0,_len1=(_ref2=null!=(_ref1=this.listeners[eventName])?_ref1:[]).length;_j<_len1;_j++)func=_ref2[_j],_results.push(func.apply(null,args));return _results},p.generatePtsCircle=function(count,centerPt){var angle,angleStep,i,legLength,_j,_results;for(legLength=this.circleFootSeparation*(2+count)/twoPi,angleStep=twoPi/count,_results=[],i=_j=0;0<=count?_j<count:_j>count;i=0<=count?++_j:--_j)angle=this.circleStartAngle+i*angleStep,_results.push(new gm.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle)));return _results},p.generatePtsSpiral=function(count,centerPt){var angle,i,legLength,pt,_j,_results;for(legLength=this.spiralLengthStart,angle=0,_results=[],i=_j=0;0<=count?_j<count:_j>count;i=0<=count?++_j:--_j)angle+=this.spiralFootSeparation/legLength+5e-4*i,pt=new gm.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle)),legLength+=twoPi*this.spiralLengthFactor/angle,_results.push(pt);return _results},p.spiderListener=function(marker,e){if(!(this.map.getZoom()<this.minZoomLevel))return this.spiderListenerTrigger(marker,e);p.oldMapPosition={bounds:this.map.getBounds(),zoom:this.map.getZoom()},this.map.setZoom(this.minZoomLevel),this.map.setCenter(marker.getPosition()),ge.addListenerOnce(this.map,"center_changed",(_=>{p.oldMapPosition=null})),ge.addListenerOnce(this.map,"idle",(e=>this.spiderListenerTrigger(marker,e)))},p.spiderListenerTrigger=function(marker,e){var m,mPt,markerPt,markerSpiderfied,nDist,nearbyMarkerData,nonNearbyMarkers,pxSq,_j,_len1,_ref1;if((markerSpiderfied=null!=marker._omsData)&&this.keepSpiderfied||this.unspiderfy(null,!1),markerSpiderfied||this.map.getStreetView().getVisible()||"GoogleEarthAPI"===this.map.getMapTypeId())return this.trigger("click",marker,e);for(nearbyMarkerData=[],nonNearbyMarkers=[],pxSq=(nDist=this.nearbyDistance)*nDist,markerPt=this.llToPt(marker.position),_j=0,_len1=(_ref1=this.markers).length;_j<_len1;_j++)null!=(m=_ref1[_j]).map&&m.getVisible()&&(mPt=this.llToPt(m.position),this.ptDistanceSq(mPt,markerPt)<pxSq?nearbyMarkerData.push({marker:m,markerPt:mPt}):nonNearbyMarkers.push(m));return 1===nearbyMarkerData.length?this.trigger("click",marker,e):(this.trigger("pre-spiderfy",marker),this.spiderfy(nearbyMarkerData,nonNearbyMarkers,marker))},p.markersNearMarker=function(marker,firstOnly){var m,mPt,markerPt,markers,nDist,pxSq,_j,_len1,_ref1,_ref2,_ref3;if(null==firstOnly&&(firstOnly=!1),null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearMarker";for(pxSq=(nDist=this.nearbyDistance)*nDist,markerPt=this.llToPt(marker.position),markers=[],_j=0,_len1=(_ref1=this.markers).length;_j<_len1&&!((m=_ref1[_j])!==marker&&null!=m.map&&m.getVisible()&&(mPt=this.llToPt(null!=(_ref2=null!=(_ref3=m._omsData)?_ref3.usualPosition:void 0)?_ref2:m.position),this.ptDistanceSq(mPt,markerPt)<pxSq&&(markers.push(m),firstOnly)));_j++);return markers},p.markerProximityData=function(){var i1,i2,m,m1,m1Data,m2,m2Data,mData,nDist,pxSq,_j,_k,_len1,_len2,_ref1,_ref2;if(null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearAnyOtherMarker";for(pxSq=(nDist=this.nearbyDistance)*nDist,mData=function(){var _j,_len1,_ref1,_ref2,_ref3,_results;for(_results=[],_j=0,_len1=(_ref1=this.markers).length;_j<_len1;_j++)m=_ref1[_j],_results.push({pt:this.llToPt(null!=(_ref2=null!=(_ref3=m._omsData)?_ref3.usualPosition:void 0)?_ref2:m.position),willSpiderfy:!1});return _results}.call(this),i1=_j=0,_len1=(_ref1=this.markers).length;_j<_len1;i1=++_j)if(null!=(m1=_ref1[i1]).getMap()&&m1.getVisible()&&!(m1Data=mData[i1]).willSpiderfy)for(i2=_k=0,_len2=(_ref2=this.markers).length;_k<_len2;i2=++_k)if(m2=_ref2[i2],i2!==i1&&null!=m2.getMap()&&m2.getVisible()&&(m2Data=mData[i2],(!(i2<i1)||m2Data.willSpiderfy)&&this.ptDistanceSq(m1Data.pt,m2Data.pt)<pxSq)){m1Data.willSpiderfy=m2Data.willSpiderfy=!0;break}return mData},p.markersNearAnyOtherMarker=function(){var i,m,mData,_j,_len1,_ref1,_results;for(mData=this.markerProximityData(),_results=[],i=_j=0,_len1=(_ref1=this.markers).length;_j<_len1;i=++_j)m=_ref1[i],mData[i].willSpiderfy&&_results.push(m);return _results},p.setImmediate=function(func){return window.setTimeout(func,0)},p.formatMarkers=function(){var _this;if(!this.basicFormatEvents&&null==this.formatTimeoutId)return this.formatTimeoutId=this.setImmediate((_this=this,function(){return _this.formatTimeoutId=null,null!=_this.projHelper.getProjection()?_this._formatMarkers():null==_this.formatIdleListener?_this.formatIdleListener=ge.addListenerOnce(_this.map,"idle",(function(){return _this._formatMarkers()})):void 0}))},p._formatMarkers=function(){var i,marker,proximities,status,_j,_k,_len1,_len2,_ref1,_results,_results1;if(this.basicFormatEvents){for(_results=[],_j=0,_len1=markers.length;_j<_len1;_j++)status=null!=(marker=markers[_j])._omsData?"SPIDERFIED":"UNSPIDERFIED",_results.push(this.trigger("format",marker,this.constructor.markerStatus[status]));return _results}for(proximities=this.markerProximityData(),_results1=[],i=_k=0,_len2=(_ref1=this.markers).length;_k<_len2;i=++_k)status=null!=(marker=_ref1[i])._omsData?"SPIDERFIED":proximities[i].willSpiderfy?"SPIDERFIABLE":"UNSPIDERFIABLE",_results1.push(this.trigger("format",marker,this.constructor.markerStatus[status]));return _results1},p.makeHighlightListenerFuncs=function(marker){return{highlight:(_this=this,function(){return marker._omsData.leg.setOptions({strokeColor:_this.legColors.highlighted[_this.map.mapTypeId],zIndex:_this.highlightedLegZIndex})}),unhighlight:function(_this){return function(){return marker._omsData.leg.setOptions({strokeColor:_this.legColors.usual[_this.map.mapTypeId],zIndex:_this.usualLegZIndex})}}(this)};var _this},p.centerMap=function(map,markers){this.bounds=new google.maps.LatLngBounds,markers.forEach((marker=>{var latlng=new google.maps.LatLng(marker.position.lat(),marker.position.lng());this.bounds.extend(latlng)})),map.fitBounds(this.bounds)},p.spiderfy=function(markerData,nonNearbyMarkers,clickedMarker){var bodyPt,footLl,footPt,footPts,leg,marker,md,nearestMarkerDatum,numFeet,spiderfiedMarkers;return this.spiderfying=!0,numFeet=markerData.length,bodyPt=this.ptAverage(function(){var _j,_len1,_results;for(_results=[],_j=0,_len1=markerData.length;_j<_len1;_j++)md=markerData[_j],_results.push(md.markerPt);return _results}()),footPts=numFeet>=this.circleSpiralSwitchover?this.generatePtsSpiral(numFeet,bodyPt).reverse():this.generatePtsCircle(numFeet,bodyPt),spiderfiedMarkers=function(){var _j,_len1,_results;for(_results=[],_j=0,_len1=footPts.length;_j<_len1;_j++)footPt=footPts[_j],footLl=this.ptToLl(footPt),nearestMarkerDatum=this.minExtract(markerData,function(_this){return function(md){return _this.ptDistanceSq(md.markerPt,footPt)}}(this)),marker=nearestMarkerDatum.marker,leg=new gm.Polyline({map:this.map,path:[marker.position,footLl],strokeColor:"#444",strokeWeight:this.legWeight,zIndex:this.usualLegZIndex}),marker._omsData={usualPosition:marker.getPosition(),usualZIndex:marker.getZIndex(),leg},this.trigger("format",marker,this.constructor.markerStatus.SPIDERFIED),marker.setPosition(footLl),marker.setZIndex(Math.round(this.spiderfiedZIndex+footPt.y)),_results.push(marker);return _results}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",spiderfiedMarkers,nonNearbyMarkers)},p.unspiderfy=function(markerNotToMove,resetZoom=!0){var listeners,marker,nonNearbyMarkers,status,unspiderfiedMarkers,_j,_len1,_ref1;if(null==markerNotToMove&&(markerNotToMove=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,unspiderfiedMarkers=[],nonNearbyMarkers=[],_j=0,_len1=(_ref1=this.markers).length;_j<_len1;_j++)null!=(marker=_ref1[_j])._omsData?(marker._omsData.leg.setMap(null),marker!==markerNotToMove&&marker.setPosition(marker._omsData.usualPosition),marker.setZIndex(marker._omsData.usualZIndex),null!=(listeners=marker._omsData.hightlightListeners)&&(ge.removeListener(listeners.highlight),ge.removeListener(listeners.unhighlight)),delete marker._omsData,marker!==markerNotToMove&&(status=this.basicFormatEvents?"UNSPIDERFIED":"SPIDERFIABLE",this.trigger("format",marker,this.constructor.markerStatus[status])),unspiderfiedMarkers.push(marker)):nonNearbyMarkers.push(marker);if(delete this.unspiderfying,delete this.spiderfied,resetZoom&&p.oldMapPosition){let pos=p.oldMapPosition;this.map.fitBounds(pos.bounds),this.map.setZoom(pos.zoom),p.oldMapPosition=null,p.oldMarker=null}return this.trigger("unspiderfy",unspiderfiedMarkers,nonNearbyMarkers),this},p.ptDistanceSq=function(pt1,pt2){var dx,dy;return(dx=pt1.x-pt2.x)*dx+(dy=pt1.y-pt2.y)*dy},p.ptAverage=function(pts){var numPts,pt,sumX,sumY,_j,_len1;for(sumX=sumY=0,_j=0,_len1=pts.length;_j<_len1;_j++)sumX+=(pt=pts[_j]).x,sumY+=pt.y;return numPts=pts.length,new gm.Point(sumX/numPts,sumY/numPts)},p.llToPt=function(ll){return this.projHelper.getProjection().fromLatLngToDivPixel(ll)},p.ptToLl=function(pt){return this.projHelper.getProjection().fromDivPixelToLatLng(pt)},p.minExtract=function(set,func){var bestIndex,bestVal,index,val,_j,_len1;for(index=_j=0,_len1=set.length;_j<_len1;index=++_j)val=func(set[index]),(null==bestIndex||val<bestVal)&&(bestVal=val,bestIndex=index);return set.splice(bestIndex,1)[0]},p.arrIndexOf=function(arr,obj){var i,_j,_len1;if(null!=arr.indexOf)return arr.indexOf(obj);for(i=_j=0,_len1=arr.length;_j<_len1;i=++_j)if(arr[i]===obj)return i;return-1},_Class}(),callbackRegEx=/(\?.*(&|&amp;)|\?)spiderfier_callback=(\w+)/,null==(scriptTag=document.currentScript)&&(scriptTag=function(){var _i,_len,_ref,_ref1,_results;for(_results=[],_i=0,_len=(_ref=document.getElementsByTagName("script")).length;_i<_len;_i++)(null!=(_ref1=(tag=_ref[_i]).getAttribute("src"))?_ref1.match(callbackRegEx):void 0)&&_results.push(tag);return _results}()[0]),null!=scriptTag&&(callbackName=null!=(_ref=scriptTag.getAttribute("src"))&&null!=(_ref1=_ref.match(callbackRegEx))?_ref1[3]:void 0)&&"function"==typeof window[callbackName]&&window[callbackName](),"function"==typeof window.spiderfier_callback&&window.spiderfier_callback()}).call(this);